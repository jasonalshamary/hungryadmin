<!DOCTYPE html>
<html lang="en">
<head>
        <meta charset="utf-8">
        <title>Hungry Admin - Linux</title>
        <link rel="stylesheet" href="/theme/css/main.css">
                <link href="/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Hungry Admin Atom Feed" />
                
        <!--[if IE]>
            <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
        <![endif]-->
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="/">Hungry Admin </a></h1>
                <nav><ul>
                                                                                    <li class="active"><a href="/category/linux.html">Linux</a></li>
                                                </ul></nav>
        </header><!-- /#banner -->
                
            

                            <aside id="featured" class="body">
                <article>
                    <h1 class="entry-title"><a href="/building-a-static-blog-and-deploying-it-with-saltstack.html">Building a static blog and deploying it with SaltStack</a></h1> 
                    <footer class="post-info">
        <abbr class="published" title="2013-09-05T00:00:00">
                Thu 05 September 2013
        </abbr>

                <address class="vcard author">
                By <a class="url fn" href="/author/forrest-alvarez.html">Forrest Alvarez</a>
        </address>
        <p>In <a href="/category/linux.html">Linux</a>. </p>
<p>tags: <a href="/tag/salt.html">salt</a><a href="/tag/saltstack.html">saltstack</a><a href="/tag/pelican.html">pelican</a></p>
</footer><!-- /.post-info --><p>I'll be discussing the setup of the blog with this initial post, the main focus will be on the usage of SaltStack.</p>
<p>Our setup is going to consist of the following:</p>
<p>1 droplet from DigitalOcean (Ubuntu).</p>
<p>Our static blog (Pelican) running through nginx and a virtualenv.</p>
<p>Saltstack pulling in our server configuration.</p>
<p>So basically the configuration is going to go like this:</p>
<ol class="arabic simple">
<li>Spin up your droplet (I'm using Ubuntu, but the salt states I'm using should support multiple distros).</li>
<li>Install salt.</li>
<li>Use salt to perform the rest of the setup.</li>
<li>From there it's all blog content related.</li>
</ol>
<p>Our first step is to get salt installed:</p>
<p>We'll be going through the steps here: <a class="reference external" href="http://docs.saltstack.com/topics/installation/ubuntu.html">http://docs.saltstack.com/topics/installation/ubuntu.html</a></p>
<p>For Ubuntu you may or may not need to install the following package, check if you have the 'add-apt-repository' command, I did not:</p>
<p>apt-get install python-software-properties</p>
<p>For me this still didn't provide it, so I had to run</p>
<p>apt-get install add-software-properties-common and I was all set to go.</p>
<p>Ok now I had the add-apt-repository command available I added the saltstack repo: add-apt-repository ppa:saltstack/salt</p>
<p>Since we're just going to have one server here, we're going to configure it as a masterless minion:</p>
<p><a class="reference external" href="http://docs.saltstack.com/topics/tutorials/quickstart.html">http://docs.saltstack.com/topics/tutorials/quickstart.html</a></p>
<p>So we'll start by installing just the salt-minion with:</p>
<p>apt-get install salt-minion.</p>
<p>Now I like to run a quick test here to make sure things are working properly, so lets install nginx real quick.</p>
<p>If you're following along in the quickstart for the masterless minion, scroll down near the bottom and follow their creation with a few slight modifications (we'll update this later once we have the structure all fleshed out):</p>
<p>/sr/salt/top.sls:</p>
<div class="highlight"><pre><span class="l-Scalar-Plain">base</span><span class="p-Indicator">:</span>
  <span class="s">&#39;*&#39;</span><span class="p-Indicator">:</span>
    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">webserver</span>
</pre></div>
<p>/srv/salt/webserver.sls</p>
<div class="highlight"><pre><span class="l-Scalar-Plain">nginx</span><span class="p-Indicator">:</span>
  <span class="l-Scalar-Plain">pkg</span><span class="p-Indicator">:</span>
    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">installed</span>
</pre></div>
<p>Ok now that those are saved, just run salt-call --local state.highstate -l debug, it should look like the following:</p>
<div class="highlight"><pre><span class="nb">local</span>:
----------
    State: - pkg
    Name:      nginx
    Function:  installed
        Result:    True
        Comment:   Package nginx installed
        Changes:   libgd2: <span class="o">{</span><span class="s1">&#39;new&#39;</span>: <span class="s1">&#39;1&#39;</span>, <span class="s1">&#39;old&#39;</span>: <span class="s1">&#39;&#39;</span><span class="o">}</span>
                   httpd: <span class="o">{</span><span class="s1">&#39;new&#39;</span>: <span class="s1">&#39;1&#39;</span>, <span class="s1">&#39;old&#39;</span>: <span class="s1">&#39;&#39;</span><span class="o">}</span>
                   nginx-common: <span class="o">{</span><span class="s1">&#39;new&#39;</span>: <span class="s1">&#39;1.2.6-1ubuntu3.2&#39;</span>, <span class="s1">&#39;old&#39;</span>: <span class="s1">&#39;&#39;</span><span class="o">}</span>
                   nginx-full: <span class="o">{</span><span class="s1">&#39;new&#39;</span>: <span class="s1">&#39;1.2.6-1ubuntu3.2&#39;</span>, <span class="s1">&#39;old&#39;</span>: <span class="s1">&#39;&#39;</span><span class="o">}</span>
                   nginx: <span class="o">{</span><span class="s1">&#39;new&#39;</span>: <span class="s1">&#39;1.2.6-1ubuntu3.2&#39;</span>, <span class="s1">&#39;old&#39;</span>: <span class="s1">&#39;&#39;</span><span class="o">}</span>
                   libxslt1.1: <span class="o">{</span><span class="s1">&#39;new&#39;</span>: <span class="s1">&#39;1.1.27-1ubuntu2&#39;</span>, <span class="s1">&#39;old&#39;</span>: <span class="s1">&#39;&#39;</span><span class="o">}</span>
                   libjpeg-turbo8: <span class="o">{</span><span class="s1">&#39;new&#39;</span>: <span class="s1">&#39;1.2.1-0ubuntu2&#39;</span>, <span class="s1">&#39;old&#39;</span>: <span class="s1">&#39;&#39;</span><span class="o">}</span>
                   libgd2-noxpm: <span class="o">{</span><span class="s1">&#39;new&#39;</span>: <span class="s1">&#39;2.0.36~rc1~dfsg-6.1ubuntu1&#39;</span>, <span class="s1">&#39;old&#39;</span>: <span class="s1">&#39;&#39;</span><span class="o">}</span>
                   libjpeg8: <span class="o">{</span><span class="s1">&#39;new&#39;</span>: <span class="s1">&#39;8c-2ubuntu7&#39;</span>, <span class="s1">&#39;old&#39;</span>: <span class="s1">&#39;&#39;</span><span class="o">}</span>
</pre></div>
<p>Awesome, so now nginx is installed by salt.</p>
<p>Now there are a few things we're going to want to configure here, and a few items we'll have to modify later as we go through setting up the blog itself.</p>
<p>The first thing I want to do is install fail2ban. So lets create that sls</p>
<p>/srv/salt/fail2ban.sls</p>
<div class="highlight"><pre><span class="l-Scalar-Plain">fail2ban</span><span class="p-Indicator">:</span>
  <span class="l-Scalar-Plain">pkg</span><span class="p-Indicator">:</span>
    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">installed</span>
</pre></div>
<p>and lets update our top.sls again so this gets included:</p>
<p>/srv/salt/top.sls:</p>
<div class="highlight"><pre><span class="l-Scalar-Plain">base</span><span class="p-Indicator">:</span>
  <span class="s">&#39;*&#39;</span><span class="p-Indicator">:</span>
    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">webserver</span>
    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">fail2ban</span>
</pre></div>
<p>Ok lets run our highstate again: salt-call --local state.highstate -l debug</p>
<p>And you should see output like this:</p>
<div class="highlight"><pre><span class="nb">local</span>:
----------
    State: - pkg
    Name:      fail2ban
    Function:  installed
        Result:    True
        Comment:   Package fail2ban installed
        Changes:   python2.7-pyinotify: <span class="o">{</span><span class="s1">&#39;new&#39;</span>: <span class="s1">&#39;1&#39;</span>, <span class="s1">&#39;old&#39;</span>: <span class="s1">&#39;&#39;</span><span class="o">}</span>
                   python-pyinotify: <span class="o">{</span><span class="s1">&#39;new&#39;</span>: <span class="s1">&#39;0.9.3-1.1ubuntu1&#39;</span>, <span class="s1">&#39;old&#39;</span>: <span class="s1">&#39;&#39;</span><span class="o">}</span>
                   fail2ban: <span class="o">{</span><span class="s1">&#39;new&#39;</span>: <span class="s1">&#39;0.8.7.1-1&#39;</span>, <span class="s1">&#39;old&#39;</span>: <span class="s1">&#39;&#39;</span><span class="o">}</span>

----------
    State: - pkg
    Name:      nginx
    Function:  installed
        Result:    True
        Comment:   Package nginx is already installed
        Changes:
</pre></div>
<p>great, now fail2ban will be installed, by default the service starts but let's make sure it does. Modify your /srv/salt/fail2ban.sls to look like this:</p>
<div class="highlight"><pre><span class="l-Scalar-Plain">fail2ban</span><span class="p-Indicator">:</span>
  <span class="l-Scalar-Plain">pkg</span><span class="p-Indicator">:</span>
    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">installed</span>
  <span class="l-Scalar-Plain">service</span><span class="p-Indicator">:</span>
    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">running</span>
    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">watch</span><span class="p-Indicator">:</span>
      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">file</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">/etc/fail2ban/fail2ban.conf</span>
</pre></div>
<p>So we'll get details back on our other items, but what we're focusing on is this:</p>
<div class="highlight"><pre>----------
    State: - service
    Name:      fail2ban
    Function:  running
        Result:    False
        Comment:   The following requisites were not found:
                   watch: <span class="o">{</span><span class="s1">&#39;file&#39;</span>: <span class="s1">&#39;/etc/fail2ban/fail2ban.conf&#39;</span><span class="o">}</span>

        Changes:
</pre></div>
<p>Now you can see the result here is 'false', does that mean things failed? Let's modify the fail2ban.conf and see. Odd, after adding a line to the fail2ban.conf file I still get the following:</p>
<div class="highlight"><pre>----------
    State: - service
    Name:      fail2ban
    Function:  running
        Result:    False
        Comment:   The following requisites were not found:
                   watch: <span class="o">{</span><span class="s1">&#39;file&#39;</span>: <span class="s1">&#39;/etc/fail2ban/fail2ban.conf&#39;</span><span class="o">}</span>

        Changes:
</pre></div>
<p>Ok lets modify our fail2ban.sls to just require the package, let's also add a require on the service to ensure it tries to start after fail2ban is installed. (this isn't required in 0.17 and forward since they process in order, but it's nice to have):</p>
<div class="highlight"><pre><span class="l-Scalar-Plain">fail2ban</span><span class="p-Indicator">:</span>
  <span class="l-Scalar-Plain">pkg</span><span class="p-Indicator">:</span>
    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">installed</span>
  <span class="l-Scalar-Plain">service</span><span class="p-Indicator">:</span>
    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">running</span>
    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">watch</span><span class="p-Indicator">:</span>
      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">pkg</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">fail2ban</span>
    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">require</span><span class="p-Indicator">:</span>
      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">pkg</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">fail2ban</span>
</pre></div>
<p>Now things are looking better:</p>
<div class="highlight"><pre>----------
    State: - service
    Name:      fail2ban
    Function:  running
        Result:    True
        Comment:   The service fail2ban is already running
        Changes:
</pre></div>
<p>So why did this fail before? The reason it fails is because salt doesn't understand that we want to modify the fail2ban.conf, because we didn't declare it inside of the fail2ban.sls. Imagine it like someone has handed you a stack of papers, each with a number on them. They then ask you to find a numbered paper to read them the details on, well they call out 7, and you sort through the stack of papers, but you don't have that paper! How can you provide details about something you don't possess or have in your hand? It's exactly the same with Salt, if you don't say 'hey this is the file, this is the content', and then tell it to watch that file for changes, it doesn't know what to do because it doesn't think the file exists! Since we don't have anything specific going on inside the fail2ban.conf, we aren't going to modify it.</p>
<p>What we DO need to modify however is the ssh_config file, so we can change the port, and disable root login for security purposes. So lets start by creating an ssh directory for salt, we don't want to clog up our main directory, we'll move the other content as well, and change the naming scheme to better represent both the files, and to meet the requirements salt has set.</p>
<p>First lets make some directories for our existing content, create the following:</p>
<p>mkdir /srv/salt/fail2ban
mkdir /srv/salt/nginx
mkdir /srv/salt/ssh</p>
<p>Now move the files:</p>
<p>mv /srv/salt/fail2ban.sls /srv/salt/fail2ban/init.sls</p>
<p>mv /srv/salt/webserver.sls /srv/salt/nginx/init.sls</p>
<p>cp /etc/ssh/ssh_config /srv/salt/ssh/ssh_config</p>
<p>Now you're thinking to yourself 'woah woah woah, why did this guy change the file names to inits??'. The reasoning behind this is now that they're no longer in top level directories, we still want them to get applied, and the init just inherits the name of the directory, which is great for having a base file that would get configured everywhere.</p>
<p>So just to make sure we didn't break anything, let's run our highstate again:</p>
<div class="highlight"><pre>salt-call --local state.highstate -l debug

<span class="nb">local</span>:
----------
    State: - pkg
    Name:      fail2ban
    Function:  installed
        Result:    True
        Comment:   Package fail2ban is already installed
        Changes:
----------
    State: - service
    Name:      fail2ban
    Function:  running
        Result:    True
        Comment:   The service fail2ban is already running
        Changes:
</pre></div>
<p>Wait a second where did nginx go? Remember how we moved webserver.sls to be init.sls in the nginx dir? Well we didn't update our top.sls, so lets do that now:</p>
<div class="highlight"><pre><span class="l-Scalar-Plain">base</span><span class="p-Indicator">:</span>
  <span class="s">&#39;*&#39;</span><span class="p-Indicator">:</span>
    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">nginx</span>
    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">fail2ban</span>
</pre></div>
<p>Lets run the highstate again:</p>
<div class="highlight"><pre><span class="nb">local</span>:
----------
    State: - pkg
    Name:      fail2ban
    Function:  installed
        Result:    True
        Comment:   Package fail2ban is already installed
        Changes:
----------
    State: - pkg
    Name:      nginx
    Function:  installed
        Result:    True
        Comment:   Package nginx is already installed
        Changes:
----------
    State: - service
    Name:      fail2ban
    Function:  running
        Result:    True
        Comment:   The service fail2ban is already running
        Changes:
</pre></div>
<p>Awesome, now things are looking a lot better! Lets move on to managing our sshd_config. I'm going to assume familiarity with the sshd_config, I've modified the default port, as well as the ability for root to login, modify whatever you want, and let's create our init.sls:</p>
<div class="highlight"><pre><span class="l-Scalar-Plain">ssh</span><span class="p-Indicator">:</span>
  <span class="l-Scalar-Plain">pkg</span><span class="p-Indicator">:</span>
    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">installed</span>
  <span class="l-Scalar-Plain">service</span><span class="p-Indicator">:</span>
    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">running</span>
    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">require</span><span class="p-Indicator">:</span>
      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">pkg</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">ssh</span>
    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">watch</span><span class="p-Indicator">:</span>
      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">file</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">/etc/ssh/ssd_config</span>


<span class="l-Scalar-Plain">/etc/ssh/sshd_config</span><span class="p-Indicator">:</span>
  <span class="l-Scalar-Plain">file</span><span class="p-Indicator">:</span>
    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">managed</span>
    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">source</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">salt://ssh/sshd_config</span>
    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">mode</span><span class="p-Indicator">:</span> <span class="s">&#39;0644&#39;</span>
    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">user</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">root</span>
    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">group</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">root</span>
    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">require</span><span class="p-Indicator">:</span>
      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">pkg</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">ssh</span>
</pre></div>
<p>Ok we've done quite a bit here, so we install the package. We ensure the service is running, that the requires are in place, and we're watching our ssh_config file. We also set up the ssh_config so that all our changes get applied properly. You'll notice that I've put single quotes around the mode, due to the way YAML is formatted, you can't have a leading 0 or it treats the value like a hexedecimal value, so just wrap it in single quotes. Let's see what our output looks like now:</p>
<div class="highlight"><pre><span class="nb">local</span>:
----------
    State: - pkg
    Name:      ssh
    Function:  installed
        Result:    True
        Comment:   Package ssh is already installed
        Changes:
----------
    State: - file
    Name:      /etc/ssh/sshd_config
    Function:  managed
        Result:    True
        Comment:   File /etc/ssh/sshd_config is in the correct state
        Changes:
----------
    State: - pkg
    Name:      fail2ban
    Function:  installed
        Result:    True
        Comment:   Package fail2ban is already installed
        Changes:
----------
    State: - pkg
    Name:      nginx
    Function:  installed
        Result:    True
        Comment:   Package nginx is already installed
        Changes:
----------
    State: - service
    Name:      fail2ban
    Function:  running
        Result:    True
        Comment:   The service fail2ban is already running
        Changes:
----------
    State: - service
    Name:      ssh
    Function:  running
        Result:    True
        Comment:   The service ssh is already running
        Changes:
</pre></div>
<p>Awesome, so everything seems to be going well, lets modify our /srv/salt/ssh/sshd_config for fun (I'm just going to add a comment), and re-run the highstate with salt-call --local state.highstate -l debug:</p>
<div class="highlight"><pre><span class="nb">local</span>:
----------
    State: - pkg
    Name:      ssh
    Function:  installed
        Result:    True
        Comment:   Package ssh is already installed
        Changes:
----------
    State: - file
    Name:      /etc/ssh/sshd_config
    Function:  managed
        Result:    True
        Comment:   File /etc/ssh/sshd_config updated
        Changes:   diff: ---
+++
@@ -15,6 +15,7 @@
 <span class="c"># Site-wide defaults for some commonly used options.  For a comprehensive</span>
 <span class="c"># list of available options, their meanings and defaults, please see the</span>
 <span class="c"># ssh_config(5) man page.</span>
+#  <span class="nb">test</span>

<span class="nb"> </span>Host *
 <span class="c">#   ForwardAgent no</span>


----------
    State: - pkg
    Name:      fail2ban
    Function:  installed
        Result:    True
        Comment:   Package fail2ban is already installed
        Changes:
----------
    State: - pkg
    Name:      nginx
    Function:  installed
        Result:    True
        Comment:   Package nginx is already installed
        Changes:
----------
    State: - service
    Name:      fail2ban
    Function:  running
        Result:    True
        Comment:   The service fail2ban is already running
        Changes:
----------
    State: - service
    Name:      ssh
    Function:  running
        Result:    True
        Comment:   Service restarted
        Changes:   ssh: True
</pre></div>
<p>You can see that we've added that comment line, and then the service was restarted because it's watching the ssh_config file, just like we wanted! Now modify that back, no reason to waste a comment line. Ok, so we've got ssh locked down in some fashion, nginx is installed, and we've fail2ban installed as well. We've already got python installed, but we're missing things like virtualenv which are key.</p>
<p>Let's create /srv/salt/python/ so we can get Python and the other associated items configured (and we can show more cool salt stuff). So we're going to start breaking things out here. Let's pretend for a second this isn't a single machine, but an environment. You wouldn't want to install setuptools on a machine that only needs python would you? No of course not, so we break out our /srv/salt/python/ directory into two files for right now, the first is /srv/salt/python/init.sls, it looks like this:</p>
<div class="highlight"><pre><span class="l-Scalar-Plain">python</span><span class="p-Indicator">:</span>
  <span class="l-Scalar-Plain">pkg</span><span class="p-Indicator">:</span>
    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">installed</span>
</pre></div>
<p>Super easy right? Just make sure python is installed.</p>
<p>Let's get pip installed as well, let's make another sls. This may seem verbose, but for the time being it isn't a lot of work and we want to keep each item seperate. So create a pip.sls</p>
<div class="highlight"><pre><span class="l-Scalar-Plain">python-pip</span><span class="p-Indicator">:</span>
  <span class="l-Scalar-Plain">pkg</span><span class="p-Indicator">:</span>
    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">installed</span>
</pre></div>
<p>And modify the top.sls again:</p>
<div class="highlight"><pre><span class="l-Scalar-Plain">base</span><span class="p-Indicator">:</span>
<span class="s">&#39;*&#39;</span><span class="p-Indicator">:</span>
  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">nginx</span>
  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">fail2ban</span>
  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">ssh</span>
  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">python.pip</span>
</pre></div>
<p>Run our salt-call --local state.highstate -l debug again and we get this nice big wall of spam:</p>
<div class="highlight"><pre>State: - pkg
Name:      python-pip
Function:  installed
    Result:    True
    Comment:   Package python-pip installed
    Changes:   build-essential: <span class="o">{</span><span class="s1">&#39;new&#39;</span>: <span class="s1">&#39;11.6ubuntu4&#39;</span>, <span class="s1">&#39;old&#39;</span>: <span class="s1">&#39;&#39;</span><span class="o">}</span>
               c++-compiler: <span class="o">{</span><span class="s1">&#39;new&#39;</span>: <span class="s1">&#39;1&#39;</span>, <span class="s1">&#39;old&#39;</span>: <span class="s1">&#39;&#39;</span><span class="o">}</span>
               libmpfr4: <span class="o">{</span><span class="s1">&#39;new&#39;</span>: <span class="s1">&#39;3.1.1-1&#39;</span>, <span class="s1">&#39;old&#39;</span>: <span class="s1">&#39;&#39;</span><span class="o">}</span>
               libppl-c4: <span class="o">{</span><span class="s1">&#39;new&#39;</span>: <span class="s1">&#39;1.0-1ubuntu2&#39;</span>, <span class="s1">&#39;old&#39;</span>: <span class="s1">&#39;&#39;</span><span class="o">}</span>
               libalgorithm-merge-perl: <span class="o">{</span><span class="s1">&#39;new&#39;</span>: <span class="s1">&#39;0.08-2&#39;</span>, <span class="s1">&#39;old&#39;</span>: <span class="s1">&#39;&#39;</span><span class="o">}</span>
               dpkg-dev: <span class="o">{</span><span class="s1">&#39;new&#39;</span>: <span class="s1">&#39;1.16.10ubuntu1&#39;</span>, <span class="s1">&#39;old&#39;</span>: <span class="s1">&#39;&#39;</span><span class="o">}</span>
               linux-libc-dev: <span class="o">{</span><span class="s1">&#39;new&#39;</span>: <span class="s1">&#39;3.8.0-29.42&#39;</span>, <span class="s1">&#39;old&#39;</span>: <span class="s1">&#39;&#39;</span><span class="o">}</span>
               cpp-4.7: <span class="o">{</span><span class="s1">&#39;new&#39;</span>: <span class="s1">&#39;4.7.3-1ubuntu1&#39;</span>, <span class="s1">&#39;old&#39;</span>: <span class="s1">&#39;&#39;</span><span class="o">}</span>
               libalgorithm-diff-xs-perl: <span class="o">{</span><span class="s1">&#39;new&#39;</span>: <span class="s1">&#39;0.04-2build3&#39;</span>, <span class="s1">&#39;old&#39;</span>: <span class="s1">&#39;&#39;</span><span class="o">}</span>
               gcc: <span class="o">{</span><span class="s1">&#39;new&#39;</span>: <span class="s1">&#39;4:4.7.3-1ubuntu10&#39;</span>, <span class="s1">&#39;old&#39;</span>: <span class="s1">&#39;&#39;</span><span class="o">}</span>
               make: <span class="o">{</span><span class="s1">&#39;new&#39;</span>: <span class="s1">&#39;3.81-8.2ubuntu2&#39;</span>, <span class="s1">&#39;old&#39;</span>: <span class="s1">&#39;&#39;</span><span class="o">}</span>
               libitm1: <span class="o">{</span><span class="s1">&#39;new&#39;</span>: <span class="s1">&#39;4.7.3-1ubuntu1&#39;</span>, <span class="s1">&#39;old&#39;</span>: <span class="s1">&#39;&#39;</span><span class="o">}</span>
               libquadmath0: <span class="o">{</span><span class="s1">&#39;new&#39;</span>: <span class="s1">&#39;4.7.3-1ubuntu1&#39;</span>, <span class="s1">&#39;old&#39;</span>: <span class="s1">&#39;&#39;</span><span class="o">}</span>
               libfile-fcntllock-perl: <span class="o">{</span><span class="s1">&#39;new&#39;</span>: <span class="s1">&#39;0.14-2&#39;</span>, <span class="s1">&#39;old&#39;</span>: <span class="s1">&#39;&#39;</span><span class="o">}</span>
               c-compiler: <span class="o">{</span><span class="s1">&#39;new&#39;</span>: <span class="s1">&#39;1&#39;</span>, <span class="s1">&#39;old&#39;</span>: <span class="s1">&#39;&#39;</span><span class="o">}</span>
               g++: <span class="o">{</span><span class="s1">&#39;new&#39;</span>: <span class="s1">&#39;4:4.7.3-1ubuntu10&#39;</span>, <span class="s1">&#39;old&#39;</span>: <span class="s1">&#39;&#39;</span><span class="o">}</span>
               libcloog-ppl1: <span class="o">{</span><span class="s1">&#39;new&#39;</span>: <span class="s1">&#39;0.16.1-1&#39;</span>, <span class="s1">&#39;old&#39;</span>: <span class="s1">&#39;&#39;</span><span class="o">}</span>
               libgcc-4.7-dev: <span class="o">{</span><span class="s1">&#39;new&#39;</span>: <span class="s1">&#39;4.7.3-1ubuntu1&#39;</span>, <span class="s1">&#39;old&#39;</span>: <span class="s1">&#39;&#39;</span><span class="o">}</span>
               libmpc2: <span class="o">{</span><span class="s1">&#39;new&#39;</span>: <span class="s1">&#39;0.9-4build1&#39;</span>, <span class="s1">&#39;old&#39;</span>: <span class="s1">&#39;&#39;</span><span class="o">}</span>
               libdpkg-perl: <span class="o">{</span><span class="s1">&#39;new&#39;</span>: <span class="s1">&#39;1.16.10ubuntu1&#39;</span>, <span class="s1">&#39;old&#39;</span>: <span class="s1">&#39;&#39;</span><span class="o">}</span>
               libstdc++-dev: <span class="o">{</span><span class="s1">&#39;new&#39;</span>: <span class="s1">&#39;1&#39;</span>, <span class="s1">&#39;old&#39;</span>: <span class="s1">&#39;&#39;</span><span class="o">}</span>
               libc6-dev: <span class="o">{</span><span class="s1">&#39;new&#39;</span>: <span class="s1">&#39;2.17-0ubuntu5&#39;</span>, <span class="s1">&#39;old&#39;</span>: <span class="s1">&#39;&#39;</span><span class="o">}</span>
               libstdc++6-4.7-dev: <span class="o">{</span><span class="s1">&#39;new&#39;</span>: <span class="s1">&#39;4.7.3-1ubuntu1&#39;</span>, <span class="s1">&#39;old&#39;</span>: <span class="s1">&#39;&#39;</span><span class="o">}</span>
               libc-dev-bin: <span class="o">{</span><span class="s1">&#39;new&#39;</span>: <span class="s1">&#39;2.17-0ubuntu5&#39;</span>, <span class="s1">&#39;old&#39;</span>: <span class="s1">&#39;&#39;</span><span class="o">}</span>
               manpages-dev: <span class="o">{</span><span class="s1">&#39;new&#39;</span>: <span class="s1">&#39;3.44-0ubuntu1&#39;</span>, <span class="s1">&#39;old&#39;</span>: <span class="s1">&#39;&#39;</span><span class="o">}</span>
               python-pip: <span class="o">{</span><span class="s1">&#39;new&#39;</span>: <span class="s1">&#39;1.3.1-0ubuntu1&#39;</span>, <span class="s1">&#39;old&#39;</span>: <span class="s1">&#39;&#39;</span><span class="o">}</span>
               libalgorithm-diff-perl: <span class="o">{</span><span class="s1">&#39;new&#39;</span>: <span class="s1">&#39;1.19.02-3&#39;</span>, <span class="s1">&#39;old&#39;</span>: <span class="s1">&#39;&#39;</span><span class="o">}</span>
               libppl12: <span class="o">{</span><span class="s1">&#39;new&#39;</span>: <span class="s1">&#39;1.0-1ubuntu2&#39;</span>, <span class="s1">&#39;old&#39;</span>: <span class="s1">&#39;&#39;</span><span class="o">}</span>
               gcc-4.7: <span class="o">{</span><span class="s1">&#39;new&#39;</span>: <span class="s1">&#39;4.7.3-1ubuntu1&#39;</span>, <span class="s1">&#39;old&#39;</span>: <span class="s1">&#39;&#39;</span><span class="o">}</span>
               linux-kernel-headers: <span class="o">{</span><span class="s1">&#39;new&#39;</span>: <span class="s1">&#39;1&#39;</span>, <span class="s1">&#39;old&#39;</span>: <span class="s1">&#39;&#39;</span><span class="o">}</span>
               patch: <span class="o">{</span><span class="s1">&#39;new&#39;</span>: <span class="s1">&#39;2.6.1-3ubuntu2&#39;</span>, <span class="s1">&#39;old&#39;</span>: <span class="s1">&#39;&#39;</span><span class="o">}</span>
               c++abi2-dev: <span class="o">{</span><span class="s1">&#39;new&#39;</span>: <span class="s1">&#39;1&#39;</span>, <span class="s1">&#39;old&#39;</span>: <span class="s1">&#39;&#39;</span><span class="o">}</span>
               fakeroot: <span class="o">{</span><span class="s1">&#39;new&#39;</span>: <span class="s1">&#39;1.18.4-2ubuntu1&#39;</span>, <span class="s1">&#39;old&#39;</span>: <span class="s1">&#39;&#39;</span><span class="o">}</span>
               libc-dev: <span class="o">{</span><span class="s1">&#39;new&#39;</span>: <span class="s1">&#39;1&#39;</span>, <span class="s1">&#39;old&#39;</span>: <span class="s1">&#39;&#39;</span><span class="o">}</span>
               cpp: <span class="o">{</span><span class="s1">&#39;new&#39;</span>: <span class="s1">&#39;4:4.7.3-1ubuntu10&#39;</span>, <span class="s1">&#39;old&#39;</span>: <span class="s1">&#39;&#39;</span><span class="o">}</span>
               g++-4.7: <span class="o">{</span><span class="s1">&#39;new&#39;</span>: <span class="s1">&#39;4.7.3-1ubuntu1&#39;</span>, <span class="s1">&#39;old&#39;</span>: <span class="s1">&#39;&#39;</span><span class="o">}</span>
               libgmpxx4ldbl: <span class="o">{</span><span class="s1">&#39;new&#39;</span>: <span class="s1">&#39;2:5.0.5+dfsg-2ubuntu3&#39;</span>, <span class="s1">&#39;old&#39;</span>: <span class="s1">&#39;&#39;</span><span class="o">}</span>
</pre></div>
<p>Great so pip is now installed on our server.</p>
<p>Ok so we've got pip installed, lets get virtualenv taken care of. This is just a copy of our pip.sls, so copy it over: cp /srv/salt/python/pip.sls /srv/salt/python/virtualenv.sls, it should look like this:</p>
<div class="highlight"><pre><span class="l-Scalar-Plain">python-virtualenv</span><span class="p-Indicator">:</span>
  <span class="l-Scalar-Plain">pkg</span><span class="p-Indicator">:</span>
    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">installed</span>
</pre></div>
<p>Let's modify our top.sls to look like this (add virtualenv, and get rid of pip for the time being):</p>
<div class="highlight"><pre><span class="l-Scalar-Plain">base</span><span class="p-Indicator">:</span>
  <span class="s">&#39;*&#39;</span><span class="p-Indicator">:</span>
    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">nginx</span>
    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">fail2ban</span>
    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">ssh</span>
    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">python.virtualenv</span>
</pre></div>
<p>Let's run it with salt-call --local state.highstate -l debug again:</p>
<div class="highlight"><pre>  State: - pkg
  Name:      python-virtualenv
  Function:  installed
      Result:    True
      Comment:   The following packages were installed/updated: python-virtualenv.
      Changes:   python-virtualenv: <span class="o">{</span> new : 1.9.1-0ubuntu1
old :
<span class="o">}</span>
</pre></div>
<p>Next we want to install git, so create /srv/salt/git/init.sls (you'll need to create the directory), and we'll populate our file with the following:</p>
<div class="highlight"><pre><span class="l-Scalar-Plain">git</span><span class="p-Indicator">:</span>
  <span class="l-Scalar-Plain">pkg</span><span class="p-Indicator">:</span>
    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">installed</span>
</pre></div>
<p>Easy enough stuff, at some point we'll look at coming back to make this OS agnostic, but for now we don't want to get too crazy.</p>
<p>Now you might be thinking &quot;Don't we need to add this to our top.sls?&quot;, well we're not going to worry about that, because we'll be making some drastic changes shortly.</p>
<p>Ok we have virtualenv installed, and git to pull down our content. So the next step is to add our project, let's make a new directory: /srv/salt/hungryadmin, and create app.sls. Now the reason we're doing this is we want items like python/virtualenv.sls, and ngingx/init.sls to just be our DEFAULT items, so you could apply it to any server in our environment (if we had more than one). From here we can extend things, so I could have multiple subdirectories (maybe I host multiple static blogs, or a code repo, or anything), that have different applications running in them. So lets set up our static blog in the app.sls:</p>
<div class="highlight"><pre>{% set hungryadmin_venv = salt[&#39;pillar.get&#39;](&#39;hungryadmin:venv&#39;) %}
{% set hungryadmin_proj = salt[&#39;pillar.get&#39;](&#39;hungryadmin:proj&#39;) %}
{% set hungryadmin_user = salt[&#39;pillar.get&#39;](&#39;hungryadmin:user&#39;) %}

include:
  - git
  - python.pip
  - python.virtualenv

hungryadmin_venv:
  virtualenv:
    - managed
    - name: {{ hungryadmin_venv }}
    - runas: {{ hungryadmin_user }}
    - require:
      - pkg: python-virtualenv

hungryadmin:
  git:
    - latest
    - name: https://github.com/gravyboat/hungryadmin.git
    - target: {{ hungryadmin_proj }}
    - runas: {{ hungryadmin_user }}
    - force: True
    - require:
      - pkg: git
      - virtualenv: hungryadmin_venv

hungryadmin_pkgs:
  pip:
    - installed
    - bin_env {{ hungryadmin_venv }}
    - requirements: {{ hungryadmin_proj }}/requirements.txt
    - require:
      - git: hugrnyadmin
      - pkg: python-pip
      - virtualenv: hugryadmin_venv
</pre></div>
<p>Ok, so we've now got an app.sls that's going to take care of a lot of things. Now I know you're thinking &quot;what is all this pillar crap that he's using?&quot;, well we are going to get to that in a minute, the key thing here is that you understand what each of these items do, it's pretty easy to tell right? for the hungryadmin_venv variable, it's clearly the location of our virtual environment, and our hungryadmin_user, is simply our user for the virtual environment. The only slightly confusing one here is hungryadmin_proj, but even that we figure it out. We know we're going to pull our git content into the virtual environment right? So we know it has something to do with that.</p>
<p>Next let's modify our top.sls so it looks like this:</p>
<div class="highlight"><pre><span class="l-Scalar-Plain">base</span><span class="p-Indicator">:</span>
  <span class="s">&#39;*&#39;</span><span class="p-Indicator">:</span>
    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">nginx</span>
    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">fail2ban</span>
    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">ssh</span>
    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">hungryadmin.app</span>
</pre></div>
<p>So why aren't we including git, or any of the python content any longer? Because we don't need to! We've already included them in the app.sls for hungryadmin, so there's no need to include them again. Now that we've modified the top.sls lets take care of those variables I had earlier. So those values (as you can see when I defined them) are pillar values. Now the best way to think of pillar data is really just global variables, it's the first thing that the salt team state in the pillar docs, and it makes the most sense. So let's get the pillar data going. Create the following files:</p>
<p>/srv/pillar/top.sls
/srv/pillar/hungryadmin.sls</p>
<p>and populate them with this data:</p>
<p>/srv/pillar/top.sls:</p>
<div class="highlight"><pre><span class="l-Scalar-Plain">base</span><span class="p-Indicator">:</span>
  <span class="s">&#39;*&#39;</span><span class="p-Indicator">:</span>
    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">hungryadmin</span>
</pre></div>
<p>/srv/pillar/hungryadmin.sls:</p>
<div class="highlight"><pre># hungryadmin environment settings

{% set hungryadmin_user = &#39;woody&#39; %}
{% set hungryadmin_venv = &#39;/home/{0}/hungryadmin&#39;.format(hungryadmin_user) %}
{% set hungryadmin_proj = &#39;{0}/site&#39;.format(hungryadmin_venv) %}
{% set hungryadmin_url = &#39;hungryadmin.com&#39; %}
{% set hungryadmin_root = &#39;{0}/output&#39;.format(hungryadmin_proj) %}

hungryadmin:
  user: {{ hungryadmin_user }}
  venv: {{ hungryadmin_venv }}
  proj: {{ hungryadmin_proj }}
  url: {{ hungryadmin_url }}
  root: {{ hungryadmin_root }}
</pre></div>
<p>OK so basically what we've just done is say 'hey for all servers, load in these pillar files', that happens in the top.sls. Then in the hungryadmin.sls, we set our variables, so we can reference them like hungryadmin_user which will return 'woody' and so on. If we wanted we could add another section for other items.</p>
<p>Now that we have this done, we need to tell salt where to look for our pillar data. To do this edit the /etc/salt/minion (since we aren't using a master in this configuration), find the line that mentions pillar root:</p>
<div class="highlight"><pre><span class="c">#pillar_roots:</span>
<span class="c">#base:</span>
<span class="c">#  - /srv/pillar</span>
</pre></div>
<p>and change it so it looks like:</p>
<div class="highlight"><pre>pillar_roots:
  base:
    - /srv/pillar
</pre></div>
<p>Then we're done. Run the highstate again using salt-call --local state.highstate -l debug, and you should see everything get set up and configured. We create the virtual environment, and pull in out git repo. Now assuming we have our git repo hooked up properly you should be able to run a basic python server. I'm not going to get into the details here because we're mostly focusing on salt. The only thing we have left to do for this is to hook up nginx so that it's actually serving up content properly, so let's get to it!</p>
<p>We're going to start by modifying our app.sls, then we'll update nginx.</p>
<p>for the app.sls:</p>
<div class="highlight"><pre>{% set hungryadmin_venv = salt[&#39;pillar.get&#39;](&#39;hungryadmin:venv&#39;) %}
{% set hungryadmin_proj = salt[&#39;pillar.get&#39;](&#39;hungryadmin:proj&#39;) %}
{% set hungryadmin_user = salt[&#39;pillar.get&#39;](&#39;hungryadmin:user&#39;) %}

include:
  - git
  - nginx
  - python.pip
  - python.virtualenv

{{ hungryadmin_user }}:
user:
  - present
  - shell: /bin/bash
  - home: /home/{{ hungryadmin_user }}
  - uid: 2150
  - gid: 2150
  - require:
    - group: {{ hungryadmin_user }}
group:
  - present
  - gid: 2150


hungryadmin_venv:
  virtualenv:
    - managed
    - name: {{ hungryadmin_venv }}
    - runas: {{ hungryadmin_user }}
    - require:
      - pkg: python-virtualenv
      - user: {{ hungryadmin_user }}

hungryadmin:
  git:
    - latest
    - name: https://github.com/gravyboat/hungryadmin.git
    - target: {{ hungryadmin_proj }}
    - runas: {{ hungryadmin_user }}
    - force: True
    - require:
      - pkg: git
      - virtualenv: hungryadmin_venv
    - watch_in:
      - service: nginx

hungryadmin_pkgs:
  pip:
    - installed
    - bin_env: {{ hungryadmin_venv }}
    - requirements: {{ hungryadmin_proj }}/requirements.txt
    - require:
      - git: hungryadmin
      - pkg: python-pip
      - virtualenv: hungryadmin_venv

/etc/nginx/conf.d/hungryadmin.conf:
  file:
    - managed
    - source: salt://hungryadmin/files/hungryadmin.conf
    - template: jinja
    - user: root
    - group: root
    - mode: 644
    - require:
      - git: hungryadmin
      - pkg: nginx
    - watch_in:
      - service: nginx

/etc/nginx/sites-enabled/default:
  file:
    - absent
</pre></div>
<p>We've now added our conf file for this host, but we need to write that conf file now, so create /srv/salt/hungryadmin/files, and then hungryadmin.conf inside of that. It's content's look like this:</p>
<div class="highlight"><pre>server <span class="o">{</span>

    listen <span class="o">[</span>::<span class="o">]</span>:80;

    server_name <span class="o">{{</span> salt<span class="o">[</span><span class="s1">&#39;pillar.get&#39;</span><span class="o">](</span><span class="s1">&#39;hungryadmin:url&#39;</span><span class="o">)</span> <span class="o">}}</span>;
    root <span class="o">{{</span> salt<span class="o">[</span><span class="s1">&#39;pillar.get&#39;</span><span class="o">](</span><span class="s1">&#39;hungryadmin:root&#39;</span><span class="o">)</span> <span class="o">}}</span>;

    <span class="nv">location</span> <span class="o">=</span> / <span class="o">{</span>
        <span class="c"># Instead of handling the index, just</span>
        <span class="c"># rewrite / to /index.html</span>
        rewrite ^ /index.html;
    <span class="o">}</span>

    location / <span class="o">{</span>
        <span class="c"># Serve a .gz version if it exists</span>
        gzip_static on;
        <span class="c"># Try to serve the clean url version first</span>
        try_files <span class="nv">$uri</span>.htm <span class="nv">$uri</span>.html <span class="nv">$uri</span> <span class="o">=</span>404;
    <span class="o">}</span>

    <span class="nv">location</span> <span class="o">=</span> /favicon.ico <span class="o">{</span>
        <span class="c"># This never changes, so don&#39;t let it expire</span>
        expires max;
    <span class="o">}</span>

    location ^~ /theme <span class="o">{</span>
        <span class="c"># This content should very rarely, if ever, change</span>
        expires 1y;
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
<p>Ok. So now you should be able to visit the site if you modify your host file to point towards the IP address, nice job!</p>
<p>At this point we have our server configured for SSH access, as well as fail2ban, we've got all the required python items installed for our static blog, we're pulling our content down from github, and we've got nginx configured to serve the content!</p>
<p>At this point we are pretty much done, depending on which blog tool you decide to use, it might be nice to extend how the virtualenv is run in the event it needs to be rebuilt, but I'm sure you're equiped to figure that out now! Lets look at how our directory structure turned out:</p>
<p>./pillar:
hungryadmin.sls  top.sls</p>
<p>./salt:
fail2ban  git  hungryadmin  nginx  python  ssh  top.sls</p>
<p>./salt/fail2ban:
init.sls</p>
<p>./salt/git:
init.sls</p>
<p>./salt/hungryadmin:
app.sls  files</p>
<p>./salt/hungryadmin/files:
hungryadmin.conf</p>
<p>./salt/nginx:
init.sls</p>
<p>./salt/python:
init.sls  pip.sls  requirements.txt  virtualenv.sls</p>
<p>./salt/ssh:
init.sls  ssh_config</p>
<p>Ok great, so we've not got the basics of a blog ready to go. All I have to do for my Pelican blog is create my posts, build it, and then push it to github. Then run Salt and my server is ready to go! I hope this helped you out!</p>
                </article>
                                    <p class="paginator">
        Page 1 / 1
    </p>
                            </aside><!-- /#featured -->
                                                </ol><!-- /#posts-list -->
                        </section><!-- /#content -->
                    <section id="extras" class="body">
                        <div class="blogroll">
                        <h2>blogroll</h2>
                        <ul>
                                                    <li><a href="http://getpelican.com/">Pelican</a></li>
                                                    <li><a href="http://python.org/">Python.org</a></li>
                                                    <li><a href="http://jinja.pocoo.org/">Jinja2</a></li>
                                                    <li><a href="http://saltstack.org">SaltStack</a></li>
                                                </ul>
                </div><!-- /.blogroll -->
                                <div class="social">
                        <h2>social</h2>
                        <ul>
                            <li><a href="/feeds/all.atom.xml" type="application/atom+xml" rel="alternate">atom feed</a></li>
                            
                                                    <li><a href="http://github.com/gravyboat">github</a></li>
                                                </ul>
                </div><!-- /.social -->
                </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="http://getpelican.com/">Pelican</a>, which takes great advantage of <a href="http://python.org">Python</a>.
                </address><!-- /#about -->

                <p>The theme is by <a href="http://coding.smashingmagazine.com/2009/08/04/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

</body>
</html>